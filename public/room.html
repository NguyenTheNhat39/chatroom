<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="room-info">
                <div class="room-avatar" id="roomAvatar">üí¨</div>
                <div>
                    <h2 id="roomId">Loading...</h2>
                    <div class="user-count">
                        <span id="userCount">0</span> ng∆∞·ªùi online
                    </div>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <button id="leaveBtn" class="leave-btn">R·ªùi ph√≤ng</button>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="messages-container">
            <div id="messages" class="messages"></div>
            <div id="typingIndicator" class="typing-indicator"></div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="input-group">
                <button id="emojiBtn" class="emoji-btn">üòä</button>
                <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="500">
                <button id="sendBtn" class="send-btn">G·ª≠i</button>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>ƒêang k·∫øt n·ªëi...</p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        class ChatRoom {
            constructor() {
                this.socket = null;
                this.nickname = '';
                this.roomId = '';
                this.isTyping = false;
                this.typingTimeout = null;
                
                this.initializeElements();
                this.initializeSocket();
                this.bindEvents();
            }

            initializeElements() {
                this.messagesContainer = document.getElementById('messages');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.leaveBtn = document.getElementById('leaveBtn');
                this.emojiBtn = document.getElementById('emojiBtn');
                this.roomIdElement = document.getElementById('roomId');
                this.userAvatarElement = document.getElementById('userAvatar');
                this.userCountElement = document.getElementById('userCount');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.loadingOverlay = document.getElementById('loadingOverlay');
            }

            initializeSocket() {
                this.socket = io();
                
                // Get room ID from URL
                const pathParts = window.location.pathname.split('/');
                this.roomId = pathParts[pathParts.length - 1];
                this.nickname = sessionStorage.getItem('nickname') || 'Anonymous';
                
                // Update UI
                this.roomIdElement.textContent = this.roomId;
                this.userAvatarElement.textContent = this.nickname.charAt(0).toUpperCase();
                
                // Join room
                this.socket.emit('join-room', {
                    roomId: this.roomId,
                    nickname: this.nickname
                });
            }

            bindEvents() {
                // Send message
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                // Typing indicator
                this.messageInput.addEventListener('input', () => this.handleTyping());

                // Emoji button
                this.emojiBtn.addEventListener('click', () => this.toggleEmojiPicker());

                // Leave room
                this.leaveBtn.addEventListener('click', () => this.leaveRoom());

                // Socket events
                this.socket.on('room-joined', (data) => this.handleRoomJoined(data));
                this.socket.on('new-message', (data) => this.displayMessage(data));
                this.socket.on('user-joined', (data) => this.handleUserJoined(data));
                this.socket.on('user-left', (data) => this.handleUserLeft(data));
                this.socket.on('user-typing', (data) => this.handleUserTyping(data));
            }

            sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;

                this.socket.emit('send-message', { message });
                this.messageInput.value = '';
                this.stopTyping();
            }

            handleTyping() {
                if (!this.isTyping) {
                    this.isTyping = true;
                    this.socket.emit('typing', { isTyping: true });
                }

                clearTimeout(this.typingTimeout);
                this.typingTimeout = setTimeout(() => {
                    this.stopTyping();
                }, 1000);
            }

            stopTyping() {
                if (this.isTyping) {
                    this.isTyping = false;
                    this.socket.emit('typing', { isTyping: false });
                }
            }

            displayMessage(data) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                
                const isOwnMessage = data.socketId === this.socket.id;
                if (isOwnMessage) {
                    messageElement.classList.add('own-message');
                }

                const time = new Date(data.timestamp).toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Generate avatar from nickname
                const avatarText = data.nickname.charAt(0).toUpperCase();

                messageElement.innerHTML = `
                    <div class="message-avatar">${avatarText}</div>
                    <div class="message-content-wrapper">
                        <div class="message-header">
                            <span class="nickname">${data.nickname}</span>
                            <span class="timestamp">${time}</span>
                        </div>
                        <div class="message-content">${this.escapeHtml(data.message)}</div>
                    </div>
                `;

                this.messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
            }

            handleRoomJoined(data) {
                this.hideLoading();
                this.userCountElement.textContent = data.users.length;
                
                // Display existing messages
                data.messages.forEach(message => {
                    this.displayMessage(message);
                });
            }

            handleUserJoined(data) {
                this.userCountElement.textContent = data.userCount;
                this.showSystemMessage(`${data.nickname} ƒë√£ tham gia ph√≤ng`);
            }

            handleUserLeft(data) {
                this.userCountElement.textContent = data.userCount;
                this.showSystemMessage(`${data.nickname} ƒë√£ r·ªùi ph√≤ng`);
            }

            handleUserTyping(data) {
                if (data.isTyping) {
                    this.typingIndicator.innerHTML = `<span class="typing-text">${data.nickname} ƒëang nh·∫≠p...</span>`;
                } else {
                    this.typingIndicator.innerHTML = '';
                }
            }

            showSystemMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message system-message';
                messageElement.textContent = message;
                this.messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            hideLoading() {
                this.loadingOverlay.style.display = 'none';
            }

            leaveRoom() {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi ph√≤ng chat?')) {
                    window.location.href = '/';
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            toggleEmojiPicker() {
                // Simple emoji picker - you can enhance this later
                const emojis = ['üòÄ', 'üòÇ', 'üòç', 'ü§î', 'üëç', 'üëé', '‚ù§Ô∏è', 'üéâ', 'üî•', 'üíØ'];
                const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                this.messageInput.value += randomEmoji;
                this.messageInput.focus();
            }
        }

        // Initialize chat room when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ChatRoom();
        });
    </script>
</body>
</html>
